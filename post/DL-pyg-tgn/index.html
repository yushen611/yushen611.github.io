<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>tgnåŸºç¡€ | YU WENYA&#39;S BLOG</title>
<link rel="shortcut icon" href="https://yushen611.github.io/favicon.ico?v=1694708085062">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://yushen611.github.io/styles/main.css">
<link rel="alternate" type="application/atom+xml" title="tgnåŸºç¡€ | YU WENYA&#39;S BLOG - Atom Feed" href="https://yushen611.github.io/atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="
æœ¬æ–‡è®°å½•äº†å­¦ä¹ tgnä»£ç çš„è¿‡ç¨‹ã€‚
å­¦ä¹ çš„ä»£ç æ˜¯pygå®ç°tgnçš„ä»£ç ä¾‹å­ï¼špytorch_geometric/examples/tgn.py at master Â· pyg-team/pytorch_geometric (github.c..." />
    <meta name="keywords" content="" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.1/build/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://yushen611.github.io">
  <img class="avatar" src="https://yushen611.github.io/images/avatar.png?v=1694708085062" alt="">
  </a>
  <h1 class="site-title">
    YU WENYA&#39;S BLOG
  </h1>
  <p class="site-description">
    ğŸ‘  æ¬¢è¿æ¥åˆ°ä½™æ–‡æ¶¯çš„åšå®¢ ï¼  <br>
âœï¸  è¿™é‡Œå°†åˆ†äº«æœ‰å…³åŒºå—é“¾/åˆ†å¸ƒå¼ç³»ç»Ÿ/golangå¼€å‘/pythonæœºå™¨å­¦ä¹ ä¸æ•°æ®åˆ†æ/redis/mysql/é¢è¯•å…«è‚¡/leetcodåˆ·é¢˜ ç­‰é¢è¯•ä¸æŠ€æœ¯çŸ¥è¯†ã€‚
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          é¦–é¡µ
        </a>
      
    
      
        <a href="/archives" class="menu">
          å½’æ¡£
        </a>
      
    
      
        <a href="/tags" class="menu">
          æ ‡ç­¾
        </a>
      
    
      
        <a href="/post/about" class="menu">
          å…³äº
        </a>
      
    
  </div>
  <div class="social-container">
    
      
        <a href="https://github.com/yushen611" target="_blank">
          <i class="ri-github-line"></i>
        </a>
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              tgnåŸºç¡€
            </h2>
            <div class="post-info">
              <span>
                2023-08-26
              </span>
              <span>
                11 min read
              </span>
              
            </div>
            
            <div class="post-content-wrapper">
              <div class="post-content" v-pre>
                <meta name="referrer" content="no-referrer"/>
<p>æœ¬æ–‡è®°å½•äº†å­¦ä¹ tgnä»£ç çš„è¿‡ç¨‹ã€‚</p>
<p>å­¦ä¹ çš„ä»£ç æ˜¯pygå®ç°tgnçš„ä»£ç ä¾‹å­ï¼š<a href="https://github.com/pyg-team/pytorch_geometric/blob/master/examples/tgn.py">pytorch_geometric/examples/tgn.py at master Â· pyg-team/pytorch_geometric (github.com)</a></p>
<p>ä¸‹é¢ä»¥å·¥ç¨‹çš„è§’åº¦å»æ‹†åˆ†ä»£ç é€»è¾‘</p>
<h1 id="tgnåŸç†æœªå®Œå¾…ç»­">TGNåŸç†(æœªå®Œå¾…ç»­)</h1>
<h1 id="tgnä»£ç å®ç°pygç‰ˆæœ¬">TGNä»£ç å®ç°(pygç‰ˆæœ¬)</h1>
<h2 id="step1å¯¼å…¥ä¾èµ–">step1:å¯¼å…¥ä¾èµ–</h2>
<pre><code class="language-python">import os.path as osp
import torch
from sklearn.metrics import average_precision_score, roc_auc_score
from torch.nn import Linear
from torch_geometric.datasets import JODIEDataset
from torch_geometric.loader import TemporalDataLoader
from torch_geometric.nn import TGNMemory, TransformerConv
from torch_geometric.nn.models.tgn import (
    IdentityMessage,
    LastAggregator,
    LastNeighborLoader,
)
</code></pre>
<ol>
<li><code>TemporalDataLoader</code>ä¸<code>dataloader</code>çš„ä¸åŒ</li>
</ol>
<blockquote>
<p><code>TemporalDataLoader</code> ç±»æ˜¯ç”¨äºåŠ è½½æ—¶åºå›¾æ•°æ®çš„æ•°æ®åŠ è½½å™¨ã€‚</p>
<p>æ—¶åºå›¾æ•°æ®æŒ‡çš„æ˜¯å›¾æ•°æ®çš„æ—¶é—´åºåˆ—ç‰ˆæœ¬ï¼Œä¾‹å¦‚åœ¨ç¤¾äº¤ç½‘ç»œä¸­ï¼ŒèŠ‚ç‚¹å’Œè¾¹å¯èƒ½éšç€æ—¶é—´çš„æ¨ç§»è€Œå˜åŒ–ã€‚<code>TemporalDataLoader</code> çš„ç›®çš„æ˜¯å°†è¿™ç§æ—¶åºå›¾æ•°æ®åŠ è½½åˆ° PyTorch çš„å¼ é‡ä¸­ï¼Œä»¥ä¾¿è¿›è¡Œè®­ç»ƒå’Œåˆ†æã€‚</p>
</blockquote>
<ol start="2">
<li>æ—¶åºå›¾æ•°æ®æ˜¯ä»€ä¹ˆ</li>
</ol>
<blockquote>
<p>æ—¶åºå›¾æ•°æ®æ˜¯æŒ‡åœ¨å›¾ç»“æ„ä¸­è€ƒè™‘äº†æ—¶é—´ç»´åº¦çš„å›¾æ•°æ®ã€‚<strong>åœ¨æ—¶åºå›¾ä¸­ï¼ŒèŠ‚ç‚¹å’Œè¾¹å¯èƒ½ä¼šéšç€æ—¶é—´çš„æ¨ç§»è€Œå˜åŒ–</strong>ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œå±•ç¤ºäº†ä¸€ä¸ªæ—¶åºå›¾æ•°æ®çš„æ•°æ®ç»“æ„ï¼š</p>
<p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªç¤¾äº¤ç½‘ç»œï¼Œå…¶ä¸­ç”¨æˆ·æ˜¯èŠ‚ç‚¹ï¼Œä»–ä»¬ä¹‹é—´çš„äº’åŠ¨æ˜¯è¾¹ã€‚æˆ‘ä»¬å°†è€ƒè™‘ä¸åŒæ—¶é—´ç‚¹çš„å›¾å¿«ç…§ï¼Œå…¶ä¸­<strong>èŠ‚ç‚¹å’Œè¾¹çš„çŠ¶æ€å¯èƒ½éšç€æ—¶é—´è€Œå˜åŒ–</strong>ã€‚</p>
</blockquote>
<h2 id="step2å¯¼å…¥æ•°æ®é›†å¹¶åˆ’åˆ†">step2:å¯¼å…¥æ•°æ®é›†å¹¶åˆ’åˆ†</h2>
<pre><code class="language-python">device = torch.device('cuda' if torch.cuda.is_available() else 'cpu')

path = osp.join(osp.dirname(osp.realpath(__file__)), '..', 'data', 'JODIE')
dataset = JODIEDataset(path, name='wikipedia')
data = dataset[0]

# For small datasets, we can put the whole dataset on GPU and thus avoid
# expensive memory transfer costs for mini-batches:
data = data.to(device)
</code></pre>
<ol>
<li>è¿™é‡Œä¸ºä»€ä¹ˆè¦<code>data = dataset[0]</code>,å› æ­¤è¿™ä¸ªdatasetåªæœ‰ä¸€ä¸ªæ•°æ®</li>
</ol>
<figure data-type="image" tabindex="1"><img src="https://gitee.com/yushen611/img/raw/master/image-20230827183258533.png" alt="image-20230827183258533" loading="lazy"></figure>
<ol start="2">
<li><code>data</code>çš„ç±»å‹æ˜¯ä»€ä¹ˆï¼š<code>TemporalData</code></li>
</ol>
<img src="https://gitee.com/yushen611/img/raw/master/image-20230827183618147.png" alt="image-20230827183618147" style="zoom:90%;" />
<p>å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://pytorch-geometric.readthedocs.io/en/latest/generated/torch_geometric.data.TemporalData.html">torch_geometric.data.TemporalData â€” pytorch_geometric documentation (pytorch-geometric.readthedocs.io)</a></p>
<p>å®˜æ–¹æºç ï¼š<a href="https://pytorch-geometric.readthedocs.io/en/latest/_modules/torch_geometric/data/temporal.html">torch_geometric.data.temporal â€” pytorch_geometric documentation (pytorch-geometric.readthedocs.io)</a></p>
<pre><code class="language-python">from torch import Tensor
from torch_geometric.data import TemporalData

events = TemporalData(
    src=Tensor([1,2,3,4]),
    dst=Tensor([2,3,4,5]),
    t=Tensor([1000,1010,1100,2000]),
    msg=Tensor([1,1,0,0])
)

# Add additional arguments to `events`:
events.y = Tensor([1,1,0,0])

# It is also possible to set additional arguments in the constructor
events = TemporalData(
    ...,
    y=Tensor([1,1,0,0])
)

# Get the number of events:
events.num_events
&gt;&gt;&gt; 4

# Analyzing the graph structure:
events.num_nodes
&gt;&gt;&gt; 5

# PyTorch tensor functionality:
events = events.pin_memory()
events = events.to('cuda:0', non_blocking=True)
</code></pre>
<p>å‚æ•°ï¼š</p>
<ul>
<li><strong>src</strong> (<a href="https://pytorch.org/docs/master/tensors.html#torch.Tensor"><em>torch.Tensor</em></a><em>,</em> <em>optional</em>) â€“ A list of source nodes for the events with shape <code>[num_events]</code>. (default: <a href="https://docs.python.org/3/library/constants.html#None"><code>None</code></a>)</li>
<li><strong>dst</strong> (<a href="https://pytorch.org/docs/master/tensors.html#torch.Tensor"><em>torch.Tensor</em></a><em>,</em> <em>optional</em>) â€“ A list of destination nodes for the events with shape <code>[num_events]</code>. (default: <a href="https://docs.python.org/3/library/constants.html#None"><code>None</code></a>)</li>
<li><strong>t</strong> (<a href="https://pytorch.org/docs/master/tensors.html#torch.Tensor"><em>torch.Tensor</em></a><em>,</em> <em>optional</em>) â€“ The timestamps for each event with shape <code>[num_events]</code>. (default: <a href="https://docs.python.org/3/library/constants.html#None"><code>None</code></a>)</li>
<li><strong>msg</strong> (<a href="https://pytorch.org/docs/master/tensors.html#torch.Tensor"><em>torch.Tensor</em></a><em>,</em> <em>optional</em>) â€“ Messages feature matrix with shape <code>[num_events, num_msg_features]</code>. (default: <a href="https://docs.python.org/3/library/constants.html#None"><code>None</code></a>)</li>
<li>*<strong>*kwargs</strong> (<em>optional</em>) â€“ Additional attributes.</li>
</ul>
<blockquote>
<p><mark>ä¸ªäººç†è§£</mark>ï¼š</p>
<p>è¿™ä¸ªTemporalDataå°±æ˜¯åœ¨Dataçš„åŸºç¡€ä¸Šï¼ŒåŠ äº†ä¸€ä¸ªtè¡¨ç¤ºæ¯ä¸ªèŠ‚ç‚¹çš„æ—¶é—´æˆ³ã€‚åœ¨TemporalDataä¸­<strong>è¾¹ä¸è¾¹ä¹‹é—´çš„å…³</strong>ç³»ç§°ä¹‹ä¸º<strong>äº‹ä»¶</strong>ï¼Œ<strong>æ¯ä¸ªäº‹ä»¶éƒ½æœ‰ä¸€ä¸ªæ—¶é—´æˆ³</strong>ã€‚<strong>äº‹ä»¶çš„ç‰¹å¾å‘é‡</strong>è¢«è®°ä¸º<strong>msg</strong>ã€‚å¦‚æœäº‹ä»¶æœ‰å…¶ä»–å±æ€§ï¼Œè¿˜å¯ä»¥è‡ªè¡Œæ·»åŠ ã€‚</p>
</blockquote>
<pre><code class="language-python"># æ•°æ®é›†åˆ’åˆ†
train_data, val_data, test_data = data.train_val_test_split(
    val_ratio=0.15, test_ratio=0.15)

train_loader = TemporalDataLoader(
    train_data,
    batch_size=200,
    neg_sampling_ratio=1.0,
)
val_loader = TemporalDataLoader(
    val_data,
    batch_size=200,
    neg_sampling_ratio=1.0,
)
test_loader = TemporalDataLoader(
    test_data,
    batch_size=200,
    neg_sampling_ratio=1.0,
)
neighbor_loader = LastNeighborLoader(data.num_nodes, size=10, device=device)
</code></pre>
<ul>
<li><code>TemporalDataLoader</code>æ˜¯ä»€ä¹ˆ</li>
</ul>
<p>æºç ï¼š<a href="https://pytorch-geometric.readthedocs.io/en/latest/_modules/torch_geometric/loader/temporal_dataloader.html">torch_geometric.loader.temporal_dataloader â€” pytorch_geometric documentation (pytorch-geometric.readthedocs.io)</a></p>
<p>æ–‡æ¡£ï¼š<a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/loader.html">torch_geometric.loader â€” pytorch_geometric documentation (pytorch-geometric.readthedocs.io)</a></p>
<blockquote>
<p><code>TemporalDataLoader</code>:A data loader which merges succesive events of a <a href="https://pytorch-geometric.readthedocs.io/en/latest/generated/torch_geometric.data.TemporalData.html#torch_geometric.data.TemporalData"><code>torch_geometric.data.TemporalData</code></a> to a mini-batch.</p>
</blockquote>
<ul>
<li><code>LastNeighborLoader</code>æ˜¯ä»€ä¹ˆ</li>
</ul>
<p>å®˜æ–¹æºç ï¼š<a href="https://pytorch-geometric.readthedocs.io/en/latest/_modules/torch_geometric/loader/link_neighbor_loader.html">torch_geometric.loader.link_neighbor_loader â€” pytorch_geometric documentation (pytorch-geometric.readthedocs.io)</a></p>
<p>å®˜æ–¹æ–‡æ¡£ï¼šåœ¨å®˜æ–¹æ–‡æ¡£é¡µé¢æœ‰ä¸ª<code>doc</code>ï¼Œç‚¹å‡»å°±èƒ½çœ‹åˆ°æ–‡æ¡£äº†<a href="https://pytorch-geometric.readthedocs.io/en/latest/modules/loader.html#torch_geometric.loader.LinkNeighborLoader">torch_geometric.loader â€” pytorch_geometric documentation (pytorch-geometric.readthedocs.io)</a></p>
<p><code>LastNeighborLoader</code>æ˜¯ä»èŠ‚ç‚¹ä¸ºåŸºç¡€çš„ <code>torch_geometric.loader.NeighborLoader</code> æ‰©å±•è€Œæ¥ã€‚è¿™ä¸ªåŠ è½½å™¨<strong>å…è®¸åœ¨æ— æ³•è¿›è¡Œå®Œå…¨æ‰¹é‡è®­ç»ƒçš„å¤§è§„æ¨¡å›¾ä¸Šè¿›è¡Œå°æ‰¹é‡è®­ç»ƒçš„æ“ä½œ</strong>ã€‚</p>
<p>ç®€å•æ¥è¯´ï¼Œè¿™ä¸ªåŠ è½½å™¨çš„<strong>ç›®æ ‡</strong>æ˜¯åœ¨<strong>å¤§è§„æ¨¡å›¾ä¸Šè¿›è¡Œè®­ç»ƒæ—¶ï¼Œé€šè¿‡å¯¹è¾¹è¿›è¡Œé‡‡æ ·ï¼Œå¹¶æ„å»ºé‚»å±…å­å›¾æ¥å®ç°å°æ‰¹é‡è®­ç»ƒ</strong>ã€‚è¿™ä½¿å¾—<strong>åœ¨æ— æ³•è¿›è¡Œå®Œå…¨æ‰¹é‡è®­ç»ƒçš„æƒ…å†µä¸‹</strong>ï¼Œä»ç„¶å¯ä»¥é«˜æ•ˆåœ°è¿›è¡Œå›¾ç¥ç»ç½‘ç»œçš„è®­ç»ƒã€‚</p>
<h2 id="step3åˆ›å»ºæ¨¡å‹åŠå…¶ç»„ä»¶">step3:åˆ›å»ºæ¨¡å‹åŠå…¶ç»„ä»¶</h2>
<pre><code class="language-python">class GraphAttentionEmbedding(torch.nn.Module):
    def __init__(self, in_channels, out_channels, msg_dim, time_enc):
        super().__init__()
        self.time_enc = time_enc
        edge_dim = msg_dim + time_enc.out_channels
        self.conv = TransformerConv(in_channels, out_channels // 2, heads=2,
                                    dropout=0.1, edge_dim=edge_dim)

    def forward(self, x, last_update, edge_index, t, msg):
        rel_t = last_update[edge_index[0]] - t
        rel_t_enc = self.time_enc(rel_t.to(x.dtype))
        edge_attr = torch.cat([rel_t_enc, msg], dim=-1)
        return self.conv(x, edge_index, edge_attr)


class LinkPredictor(torch.nn.Module):
    def __init__(self, in_channels):
        super().__init__()
        self.lin_src = Linear(in_channels, in_channels)
        self.lin_dst = Linear(in_channels, in_channels)
        self.lin_final = Linear(in_channels, 1)

    def forward(self, z_src, z_dst):
        h = self.lin_src(z_src) + self.lin_dst(z_dst)
        h = h.relu()
        return self.lin_final(h)


memory_dim = time_dim = embedding_dim = 100

memory = TGNMemory(
    data.num_nodes,
    data.msg.size(-1),
    memory_dim,
    time_dim,
    message_module=IdentityMessage(data.msg.size(-1), memory_dim, time_dim),
    aggregator_module=LastAggregator(),
).to(device)

gnn = GraphAttentionEmbedding(
    in_channels=memory_dim,
    out_channels=embedding_dim,
    msg_dim=data.msg.size(-1),
    time_enc=memory.time_enc,
).to(device)

link_pred = LinkPredictor(in_channels=embedding_dim).to(device)
</code></pre>
<p>æ€»ç»“è¿™æ®µä»£ç ï¼Œå…¶å®å°±æ˜¯åœ¨å¹²å¦‚ä¸‹å‡ ä»¶äº‹ï¼š</p>
<ol>
<li>åˆ›å»º<code>GraphAttentionEmbedding</code>å±‚ï¼Œä½œä¸º<code>gnn</code>ï¼ˆå…¶å®å°±æ˜¯ç”¨äº†ä¸€ä¸ª<code>TransformerConv</code>ï¼‰</li>
<li>åˆ›å»º<code>LinkPredictor</code>å±‚,ä½œä¸ºå…¨è¿æ¥å±‚</li>
<li>åˆ›å»ºäº†ä¸€ä¸ª<code>TGNMemory</code>å¯¹è±¡</li>
</ol>
<p><code>TGNMemory</code>ä»‹ç»ï¼ˆç›®å‰ä¸æ˜¯å¾ˆæ‡‚åŸç†ï¼‰</p>
<blockquote>
<p><code>TGNMemory</code> æ˜¯ PyTorch Geometricï¼ˆPyGï¼‰ä¸­çš„ä¸€ä¸ªç±»ï¼Œç”¨äºå®ç°æ—¶é—´åºåˆ—å›¾ç¥ç»ç½‘ç»œï¼ˆTime-Graph Neural Networkï¼ŒTGNï¼‰çš„è®°å¿†æ¨¡å—ã€‚TGN æ˜¯ä¸€ç§ç”¨äºå¤„ç†æ—¶é—´åºåˆ—å›¾æ•°æ®çš„ç¥ç»ç½‘ç»œï¼Œå®ƒèƒ½å¤Ÿæœ‰æ•ˆåœ°å¯¹èŠ‚ç‚¹å’Œè¾¹åœ¨æ—¶é—´ä¸Šçš„æ¼”åŒ–è¿›è¡Œå»ºæ¨¡ã€‚</p>
<p>è®°å¿†æ¨¡å—åœ¨ TGN ä¸­æ‰®æ¼”ç€é‡è¦çš„è§’è‰²ï¼Œå®ƒå¯ä»¥æ•è·èŠ‚ç‚¹å’Œè¾¹çš„çŠ¶æ€éšæ—¶é—´çš„å˜åŒ–ï¼Œä»è€Œå¸®åŠ©ç½‘ç»œè¿›è¡Œæ—¶é—´åºåˆ—çš„é¢„æµ‹å’Œå»ºæ¨¡ã€‚<code>TGNMemory</code> ç±»çš„ä¸»è¦åŠŸèƒ½æ˜¯ç»´æŠ¤å›¾ä¸­èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œä»¥åŠå®ƒä»¬åœ¨æ—¶é—´åºåˆ—ä¸­çš„å˜åŒ–æƒ…å†µã€‚</p>
<p>å…·ä½“è€Œè¨€ï¼Œ<code>TGNMemory</code> ç±»å¯ä»¥æ‰§è¡Œä»¥ä¸‹åŠŸèƒ½ï¼š</p>
<ul>
<li>ä¸ºæ¯ä¸ªèŠ‚ç‚¹ç»´æŠ¤ä¸€ä¸ªè®°å¿†çŠ¶æ€ï¼Œç”¨äºæ•è·èŠ‚ç‚¹åœ¨æ—¶é—´ä¸Šçš„çŠ¶æ€å˜åŒ–ã€‚</li>
<li>åœ¨ç»™å®šçš„æ—¶é—´æˆ³ä¸Šæ›´æ–°èŠ‚ç‚¹çš„è®°å¿†çŠ¶æ€ã€‚</li>
<li>æä¾›æŸ¥è¯¢æ¥å£ï¼Œä½¿å¾—æ¨¡å‹å¯ä»¥è·å–æŸä¸ªèŠ‚ç‚¹åœ¨ç»™å®šæ—¶é—´æˆ³ä¸Šçš„çŠ¶æ€ã€‚</li>
</ul>
<p>é€šè¿‡ä½¿ç”¨ <code>TGNMemory</code>ï¼ŒTGN ç½‘ç»œå¯ä»¥æ›´å¥½åœ°ç†è§£èŠ‚ç‚¹å’Œè¾¹çš„æ—¶é—´æ¼”åŒ–ç‰¹æ€§ï¼Œä»è€Œæ›´å‡†ç¡®åœ°è¿›è¡Œæ—¶é—´åºåˆ—é¢„æµ‹ã€é“¾æ¥é¢„æµ‹ç­‰ä»»åŠ¡ã€‚</p>
</blockquote>
<h2 id="step4è®­ç»ƒå‰çš„ä»£ç å‡†å¤‡">step4:è®­ç»ƒå‰çš„ä»£ç å‡†å¤‡</h2>
<pre><code class="language-python"># å®šä¹‰æŸå¤±å‡½æ•°ä¸ä¼˜åŒ–å™¨
optimizer = torch.optim.Adam(
    set(memory.parameters()) | set(gnn.parameters())
    | set(link_pred.parameters()), lr=0.0001)
criterion = torch.nn.BCEWithLogitsLoss()
#assoc å¼ é‡å®šä¹‰
assoc = torch.empty(data.num_nodes, dtype=torch.long, device=device)
</code></pre>
<ol>
<li><code>assoc</code>ï¼šç®€å•æ¥è¯´ï¼Œå°±æ˜¯å¸®ä½ å¿«é€Ÿè·å–èŠ‚ç‚¹çš„ç´¢å¼•çš„ï¼Œåé¢è®­ç»ƒæ—¶ç”¨çš„åˆ°</li>
</ol>
<blockquote>
<p>åˆ›å»ºä¸€ä¸ªåä¸º <code>assoc</code> çš„å¼ é‡ï¼Œç”¨äºå°†å…¨å±€èŠ‚ç‚¹ç´¢å¼•æ˜ å°„åˆ°æœ¬åœ°ç´¢å¼•ã€‚åœ¨æ—¶é—´åºåˆ—å›¾æ•°æ®ä¸­ï¼ŒèŠ‚ç‚¹ç´¢å¼•é€šå¸¸æ˜¯å…¨å±€å”¯ä¸€çš„ï¼Œè€Œåœ¨æ¯ä¸ªå°æ‰¹é‡è®­ç»ƒä¸­ï¼Œæ‚¨å¯èƒ½éœ€è¦å°†è¿™äº›å…¨å±€ç´¢å¼•æ˜ å°„åˆ°å½“å‰å°æ‰¹é‡ä¸­çš„å±€éƒ¨ç´¢å¼•ã€‚</p>
<p>å…·ä½“æ¥è¯´ï¼Œ<code>assoc</code> å¼ é‡çš„é•¿åº¦ä¸º <code>data.num_nodes</code>ï¼Œè¿™æ„å‘³ç€å®ƒæœ‰è¶³å¤Ÿçš„å…ƒç´ æ¥æ˜ å°„æ•°æ®é›†ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹ã€‚è¿™ä¸ªå¼ é‡çš„ç›®çš„æ˜¯ä¸ºæ¯ä¸ªèŠ‚ç‚¹åˆ†é…ä¸€ä¸ªæœ¬åœ°ç´¢å¼•ï¼Œä½¿å¾—åœ¨å½“å‰å°æ‰¹é‡è®­ç»ƒä¸­å¯ä»¥ä½¿ç”¨è¿™äº›æœ¬åœ°ç´¢å¼•æ¥è·å–å¯¹åº”çš„èŠ‚ç‚¹ç‰¹å¾æˆ–å…¶ä»–ä¿¡æ¯ã€‚</p>
</blockquote>
<ol start="2">
<li><code>torch.empty</code></li>
</ol>
<blockquote>
<p><code>torch.empty</code> æ˜¯ PyTorch ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºåˆ›å»ºä¸€ä¸ªæœªåˆå§‹åŒ–çš„å¼ é‡ï¼ˆtensorï¼‰ï¼Œå¹¶åˆ†é…å†…å­˜ç©ºé—´ã€‚æœªåˆå§‹åŒ–çš„å¼ é‡æ„å‘³ç€å®ƒçš„å…ƒç´ å€¼åœ¨åˆ›å»ºæ—¶æ²¡æœ‰è¢«æ˜ç¡®åˆå§‹åŒ–ï¼Œå› æ­¤è¿™äº›å€¼å¯èƒ½æ˜¯ä»»æ„çš„ï¼Œå–å†³äºå†…å­˜ä¸­çš„éšæœºæ•°æ®</p>
</blockquote>
<p>å®šä¹‰ <code>train</code> å‡½æ•°ä¸<code>test</code>å‡½æ•°è¿›è¡Œè®­ç»ƒä¸æµ‹è¯•</p>
<pre><code class="language-python">def train():
    memory.train()
    gnn.train()
    link_pred.train()

    memory.reset_state()  # Start with a fresh memory.
    neighbor_loader.reset_state()  # Start with an empty graph.

    total_loss = 0
    for batch in train_loader:
        optimizer.zero_grad()
        batch = batch.to(device)

        n_id, edge_index, e_id = neighbor_loader(batch.n_id)
        assoc[n_id] = torch.arange(n_id.size(0), device=device)

        # Get updated memory of all nodes involved in the computation.
        z, last_update = memory(n_id)
        z = gnn(z, last_update, edge_index, data.t[e_id].to(device),
                data.msg[e_id].to(device))
        pos_out = link_pred(z[assoc[batch.src]], z[assoc[batch.dst]])
        neg_out = link_pred(z[assoc[batch.src]], z[assoc[batch.neg_dst]])

        loss = criterion(pos_out, torch.ones_like(pos_out))
        loss += criterion(neg_out, torch.zeros_like(neg_out))

        # Update memory and neighbor loader with ground-truth state.
        memory.update_state(batch.src, batch.dst, batch.t, batch.msg)
        neighbor_loader.insert(batch.src, batch.dst)

        loss.backward()
        optimizer.step()
        memory.detach()
        total_loss += float(loss) * batch.num_events

    return total_loss / train_data.num_events


@torch.no_grad()
def test(loader):
    memory.eval()
    gnn.eval()
    link_pred.eval()

    torch.manual_seed(12345)  # Ensure deterministic sampling across epochs.

    aps, aucs = [], []
    for batch in loader:
        batch = batch.to(device)

        n_id, edge_index, e_id = neighbor_loader(batch.n_id)
        assoc[n_id] = torch.arange(n_id.size(0), device=device)

        z, last_update = memory(n_id)
        z = gnn(z, last_update, edge_index, data.t[e_id].to(device),
                data.msg[e_id].to(device))
        pos_out = link_pred(z[assoc[batch.src]], z[assoc[batch.dst]])
        neg_out = link_pred(z[assoc[batch.src]], z[assoc[batch.neg_dst]])

        y_pred = torch.cat([pos_out, neg_out], dim=0).sigmoid().cpu()
        y_true = torch.cat(
            [torch.ones(pos_out.size(0)),
             torch.zeros(neg_out.size(0))], dim=0)

        aps.append(average_precision_score(y_true, y_pred))
        aucs.append(roc_auc_score(y_true, y_pred))

        memory.update_state(batch.src, batch.dst, batch.t, batch.msg)
        neighbor_loader.insert(batch.src, batch.dst)
    return float(torch.tensor(aps).mean()), float(torch.tensor(aucs).mean())
</code></pre>
<p><mark>TODO</mark>: è¿™é‡Œæœ‰å…³äºmemoryçš„ä¸æ˜¯å¾ˆæ‡‚ï¼Œä¹‹åçœ‹å®ŒåŸç†å›æ¥å¡«å‘</p>
<h2 id="step5è®­ç»ƒä¸è¿‡ç¨‹è®°å½•">step5:è®­ç»ƒä¸è¿‡ç¨‹è®°å½•</h2>
<pre><code class="language-python">for epoch in range(1, 51):
    loss = train()
    print(f'Epoch: {epoch:02d}, Loss: {loss:.4f}')
    val_ap, val_auc = test(val_loader)
    test_ap, test_auc = test(test_loader)
    print(f'Val AP: {val_ap:.4f}, Val AUC: {val_auc:.4f}')
    print(f'Test AP: {test_ap:.4f}, Test AUC: {test_auc:.4f}')
</code></pre>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li><a href="#tgn%E5%8E%9F%E7%90%86%E6%9C%AA%E5%AE%8C%E5%BE%85%E7%BB%AD">TGNåŸç†(æœªå®Œå¾…ç»­)</a></li>
<li><a href="#tgn%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0pyg%E7%89%88%E6%9C%AC">TGNä»£ç å®ç°(pygç‰ˆæœ¬)</a>
<ul>
<li><a href="#step1%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96">step1:å¯¼å…¥ä¾èµ–</a></li>
<li><a href="#step2%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE%E9%9B%86%E5%B9%B6%E5%88%92%E5%88%86">step2:å¯¼å…¥æ•°æ®é›†å¹¶åˆ’åˆ†</a></li>
<li><a href="#step3%E5%88%9B%E5%BB%BA%E6%A8%A1%E5%9E%8B%E5%8F%8A%E5%85%B6%E7%BB%84%E4%BB%B6">step3:åˆ›å»ºæ¨¡å‹åŠå…¶ç»„ä»¶</a></li>
<li><a href="#step4%E8%AE%AD%E7%BB%83%E5%89%8D%E7%9A%84%E4%BB%A3%E7%A0%81%E5%87%86%E5%A4%87">step4:è®­ç»ƒå‰çš„ä»£ç å‡†å¤‡</a></li>
<li><a href="#step5%E8%AE%AD%E7%BB%83%E4%B8%8E%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95">step5:è®­ç»ƒä¸è¿‡ç¨‹è®°å½•</a></li>
</ul>
</li>
</ul>

              </div>
            </div>
          </article>
        </div>

        

        
          
            <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

<div id="gitalk-container"></div>

<script>

  var gitalk = new Gitalk({
    clientID: '2c8e752d0e362a2a873f',
    clientSecret: '862c97459ff5f1f34a4ff6ce3442f41a00c107e0',
    repo: 'yushen611.github.io',
    owner: 'yushen611',
    admin: ['yushen611'],
    id: (location.pathname).substring(0, 49),      // Ensure uniqueness and length less than 50
    distractionFreeMode: false  // Facebook-like distraction free mode
  })

  gitalk.render('gitalk-container')

</script>

          

          
        

        <div class="site-footer">
  Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
  <a class="rss" href="https://yushen611.github.io/atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
